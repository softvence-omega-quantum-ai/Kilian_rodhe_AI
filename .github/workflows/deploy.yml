# name: workflow

# on:
#   push:
#     branches: ["main"]
#     paths-ignore:
#       - "README.md"

# permissions:
#   id-token: write
#   contents: read

# jobs:
#   integration:
#     name: Continuous Integration
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout Code
#         uses: actions/checkout@v4

#       - name: Lint code
#         run: echo "Successfully linted code"

#       - name: Run unit tests
#         run: echo "Running unit tests"

#   build-and-push-ecr-image:
#     name: Continuous Delivery
#     needs: integration
#     runs-on: ubuntu-latest
#     env:
#       IMAGE_TAG: latest
#     steps:
#       - name: Checkout Code
#         uses: actions/checkout@v4

#       - name: Check Docker
#         run: docker --version


#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Login to Amazon ECR
#         id: login-ecr
#         uses: aws-actions/amazon-ecr-login@v2

#       - name: Build, tag, and push image to Amazon ECR
#         id: build-image
#         env:
#           ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#           ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
#           IMAGE_TAG: ${{ env.IMAGE_TAG }}
#         run: |
#           # Validate variables to avoid empty tags
#           test -n "$ECR_REPOSITORY" || (echo "ECR_REPOSITORY is empty" && exit 1)
#           test -n "$ECR_REGISTRY" || (echo "ECR_REGISTRY is empty" && exit 1)
#           sudo docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
#           docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
#           docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
#           echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

#   Continuous-Deployment:
#     needs: build-and-push-ecr-image
#     runs-on: self-hosted
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Login to Amazon ECR
#         id: login-ecr
#         uses: aws-actions/amazon-ecr-login@v2

#       - name: Pull latest image
#         env:
#           ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#           ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
#           IMAGE_TAG: latest
#         run: |
#           test -n "$ECR_REPOSITORY" || (echo "ECR_REPOSITORY is empty" && exit 1)
#           docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

#       - name: Stop/Remove previous container (if exists)
#         run: |
#           docker ps -a -q -f name=kilian_image_ai | grep -q . && docker rm -f kilian_image_ai || true

#       - name: Run Docker container
#         env:
#           ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#           ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
#           IMAGE_TAG: latest
#         run: |
#           docker run -d \
#             --name kilian_image_ai \
#             -p 8010:8010 \
#             --ipc="host" \
#             --env-file /home/ubuntu/actions-runner/.env \
#             -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
#             -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
#             -e AWS_REGION=${{ secrets.AWS_REGION }} \
#             $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

#       - name: Clean previous images
#         run: |
#           docker system prune -f



name: deploy

on:
  push:
    branches: ["main"]

env:
  IMAGE: softvence/kilian_image_ai
  DEPLOY_PATH: /home/ubuntu/kilian_image_ai


jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE }}:latest

  deploy:
    needs: build-push
    runs-on: ubuntu-latest
    steps:
      - uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f --filter=reference="softvence/Kilian_rodhe_AI:*"